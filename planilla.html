<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agenda y Planilla - La Experiencia de Ema√∫s</title>
  <style>
    body{font-family:Arial, sans-serif;background:#f5f6fa;margin:0;padding:0;color:#111}
    header{background:#0b3b6f;color:#fff;padding:16px}
    .container{max-width:1200px;margin:20px auto;padding:16px;background:#fff;border-radius:8px}
    .tabs{display:flex;gap:10px;margin-bottom:10px}
    .tab{padding:8px 12px;border:1px solid #ccc;border-radius:8px;cursor:pointer;background:#f9fafb}
    .tab.active{background:#1f6feb;color:#fff;border-color:#1f6feb}
    table{width:100%;border-collapse:collapse;margin-bottom:12px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:top}
    th{background:#f0f2f5}
    button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;color:#fff;background:#1f6feb;margin:4px 2px}
    button.delete{background:#c62828}
    textarea{width:100%;min-height:50px;border:1px solid #ccc;border-radius:6px;padding:6px;resize:vertical}
    tr.dragging{opacity:0.5;}
  </style>
</head>
<body>
  <header>
    <h1>Agenda y Planilla - La Experiencia de Ema√∫s</h1>
  </header>
  <main class="container">
    <div class="tabs">
      <div class="tab active" data-tab="cronograma">Cronograma General</div>
      <div class="tab" data-tab="logistica">Log√≠stica y Equipos</div>
      <div class="tab" data-tab="charlas">Charlas y Momentos</div>
      <div class="tab" data-tab="checklist">Checklist General</div>
    </div>

    <!-- Cronograma General -->
    <section id="cronograma" class="panel">
      <button id="saveAll">üíæ Guardar cambios</button>
      <button id="loadSaved">üìÇ Cargar guardado</button>
      <button id="exportXlsx">‚¨áÔ∏è Exportar Excel</button>
      <button id="addCrono">‚ûï Agregar fila</button>
      <table id="tblCronograma">
        <thead>
          <tr><th>D√≠a</th><th>Hora</th><th>Actividad</th><th>Responsable</th><th>Lugar</th><th>Materiales / Observaciones</th><th>Nota espiritual</th><th>Referencia Manual</th><th>Observaciones</th><th>Acci√≥n</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Log√≠stica -->
    <section id="logistica" class="panel" style="display:none">
      <button id="addLog">‚ûï Agregar ministerio</button>
      <table id="tblLogistica">
        <thead>
          <tr><th>Ministerio</th><th>Descripci√≥n</th><th>Responsable</th><th>Tel√©fono</th><th>Referencia Manual</th><th>Observaciones</th><th>Acci√≥n</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Charlas -->
    <section id="charlas" class="panel" style="display:none">
      <button id="addCharla">‚ûï Agregar charla</button>
      <table id="tblCharlas">
        <thead>
          <tr><th>Tema</th><th>Orador</th><th>Hora</th><th>Duraci√≥n</th><th>Texto b√≠blico</th><th>Referencia Manual</th><th>Observaciones</th><th>Acci√≥n</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Checklist -->
    <section id="checklist" class="panel" style="display:none">
      <button id="addCheck">‚ûï Agregar tarea</button>
      <table id="tblChecklist">
        <thead>
          <tr><th>Tarea</th><th>Responsable</th><th>Fecha l√≠mite</th><th>Estado</th><th>Referencia Manual</th><th>Observaciones</th><th>Acci√≥n</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    let data = JSON.parse(localStorage.getItem('emausData')) || {
      cronograma: [
        ["Viernes","18:00","Llegada del equipo y ambientaci√≥n","Coordinadora","Parroquia","Velas, m√∫sica suave","Actitud de acogida","P√°g.115","Preparar bienvenida y materiales."],
        ["Viernes","19:00","Ceremonia de env√≠o del equipo","Sacerdote / Coordinadora","Capilla","Biblia, m√∫sica","Inicio del Camino","P√°gs.116‚Äì118","Compromiso de servicio."],
        ["S√°bado","09:00","Charla: Conociendo a Dios a trav√©s de conocerse a s√≠ mismo","Oradora 1","Sal√≥n","Biblia, cuaderno","Reflexi√≥n interior","P√°g.157","Agregar testimonio."],
        ["S√°bado","20:00","Ceremonia de la Pared","L√≠der espiritual","Sal√≥n principal","Cartas, mural","Encuentro con Cristo","P√°g.225","Revisar m√∫sica."],
        ["Domingo","11:00","Misa de clausura y cierre","P√°rroco","Capilla","Eucarist√≠a","Celebraci√≥n y env√≠o","P√°g.145","Organizar cantos finales."]
      ],
      logistica: [
        ["Ministerio del Pan","Alimentaci√≥n de los participantes","Marta 1","‚Äî","P√°gs.187‚Äì189","Revisar men√∫ y horarios."],
        ["Ministerio de Conductores","Transporte de caminantes","Pedro 1","‚Äî","P√°gs.190‚Äì192","Controlar rutas."],
        ["Ministerio de la Pared","Recolecci√≥n de cartas","Coordinadora","‚Äî","P√°gs.225‚Äì228","Mantener confidencialidad."]
      ],
      charlas: [
        ["Conociendo a Dios a trav√©s de conocerse a s√≠ mismo","Orador 1","09:00","20 min","Lucas 24:13‚Äì35","P√°g.157","Incluir din√°mica grupal."],
        ["Conociendo a Dios a trav√©s de las Escrituras","Orador 2","11:00","20 min","Lucas 24:13‚Äì35","P√°g.159","Lectura guiada."],
        ["Amando a Dios a trav√©s del servicio","Orador 6","09:00","20 min","Lucas 24:13‚Äì35","P√°g.173","Cerrar con compromiso."]
      ],
      checklist: [
        ["Confirmar casa de retiro","Coordinadora","2 meses antes","Pendiente","P√°g.5","Verificar disponibilidad."],
        ["Contactar sacerdotes","Coordinadora","1 mes antes","Pendiente","P√°g.6","Definir confesores."],
        ["Evaluaci√≥n post-retiro","Coordinadora","Domingo tarde","Pendiente","P√°g.235","Recolectar sugerencias."]
      ]
    };

    function renderTable(id, arr){
      const tbody=document.querySelector(`#${id} tbody`);
      tbody.innerHTML='';
      arr.forEach((r,idx)=>{
        const tr=document.createElement('tr');
        r.forEach((c,i)=>{
          const td=document.createElement('td');
          if(i === r.length-2){
            const t = document.createElement('textarea');
            t.value = c;
            t.oninput = () => { r[i] = t.value; saveLocal(); };
            td.appendChild(t);
          } else {
            td.contentEditable = true;
            td.innerText = c;
            td.oninput = () => { r[i] = td.innerText; saveLocal(); };
          }
          tr.appendChild(td);
        });
        const td = document.createElement('td');
        const del = document.createElement('button');
        del.textContent = 'Eliminar';
        del.className = 'delete';
        del.onclick = () => { arr.splice(idx,1); refreshAll(); saveLocal(); };
        td.appendChild(del);
        tr.appendChild(td);
        tbody.appendChild(tr);
      });
    }

    function enableDragSort(tbody, dataArray){
      let dragSrcRow = null;

      tbody.addEventListener('dragstart', (e) => {
        dragSrcRow = e.target;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.innerHTML);
        dragSrcRow.classList.add('dragging');
      });

      tbody.addEventListener('dragend', () => {
        if(dragSrcRow) dragSrcRow.classList.remove('dragging');
        dragSrcRow = null;
      });

      tbody.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });

      tbody.addEventListener('drop', (e) => {
        e.preventDefault();
        if(dragSrcRow && e.target.tagName === 'TD'){
          const tr = e.target.closest('tr');
          if(tr && tr !== dragSrcRow){
            const fromIndex = Array.from(tbody.children).indexOf(dragSrcRow);
            const toIndex = Array.from(tbody.children).indexOf(tr);
            const moved = dataArray.splice(fromIndex,1)[0];
            dataArray.splice(toIndex,0,moved);
            refreshAll();
            saveLocal();
          }
        }
      });

      Array.from(tbody.querySelectorAll('tr')).forEach(tr => tr.setAttribute('draggable', true));
    }

    function refreshAll(){
      renderTable('tblCronograma', data.cronograma);
      renderTable('tblLogistica', data.logistica);
      renderTable('tblCharlas', data.charlas);
      renderTable('tblChecklist', data.checklist);

      enableDragSort(document.querySelector('#tblCronograma tbody'), data.cronograma);
      enableDragSort(document.querySelector('#tblLogistica tbody'), data.logistica);
      enableDragSort(document.querySelector('#tblCharlas tbody'), data.charlas);
      enableDragSort(document.querySelector('#tblChecklist tbody'), data.checklist);
    }

    function saveLocal(){ localStorage.setItem('emausData',JSON.stringify(data)); }
    function loadLocal(){
      const d=localStorage.getItem('emausData');
      if(d){ data=JSON.parse(d); refreshAll(); alert('Datos cargados correctamente'); }
    }

    document.getElementById('saveAll').onclick = () => { saveLocal(); alert('Datos guardados localmente'); };
    document.getElementById('loadSaved').onclick = () => { loadLocal(); };

    document.getElementById('addCrono').onclick = () => { data.cronograma.push(Array(10).fill('')); refreshAll(); };
    document.getElementById('addLog').onclick = () => { data.logistica.push(Array(7).fill('')); refreshAll(); };
    document.getElementById('addCharla').onclick = () => { data.charlas.push(Array(8).fill('')); refreshAll(); };
    document.getElementById('addCheck').onclick = () => { data.checklist.push(Array(7).fill('')); refreshAll(); };

    document.querySelectorAll('.tab').forEach(tab=>{
      tab.onclick=()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
        document.getElementById(tab.dataset.tab).style.display='block';
      };
    });

    document.getElementById('exportXlsx').onclick=()=>{
      const wb=XLSX.utils.book_new();
      const addSheet=(n,a)=>{ if(!a.length)return; XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(a),n); };
      addSheet('Cronograma',data.cronograma);
      addSheet('Logistica',data.logistica);
      addSheet('Charlas',data.charlas);
      addSheet('Checklist',data.checklist);
      XLSX.writeFile(wb,'Planilla_Retiro_Emaus_Completa.xlsx');
    };

    refreshAll();
  </script>
</body>
</html>
